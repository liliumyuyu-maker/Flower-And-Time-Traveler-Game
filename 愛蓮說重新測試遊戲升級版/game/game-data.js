(function (global) {
    'use strict';

    // --- éŠæˆ²æ£‹ç›¤ä½ˆå±€ (7x7 ç’°ç‹€æ–°ç‰ˆæœ¬) ---
    const boardLayout = [
        'S', 'E', 'M', 'E', 'E', 'E', 'S',
        'E', null, null, null, null, null, 'E',
        'M', null, null, null, null, null, 'E',
        'E', null, null, null, null, null, 'M',
        'E', null, null, null, null, null, 'E',
        'M', null, null, null, null, null, 'E',
        'S', 'E', 'M', 'E', 'E', 'E', 'S'
    ];
    // æ£‹ç›¤çš„è·¯å¾‘é †åºï¼ˆå®Œæ•´å¤–åœˆ 24 æ ¼ï¼Œä¾åºç¹ä¸€åœˆï¼‰
    const boardPath = [
        // åº•é‚Šï¼ˆå·¦â†’å³ï¼‰
        42, 43, 44, 45, 46, 47, 48,
        // å³é‚Šï¼ˆä¸‹â†’ä¸Šï¼Œä¸å«è§’ 48ï¼Œå«å³ä¸Šè§’ 6ï¼‰
        41, 34, 27, 20, 13, 6,
        // ä¸Šé‚Šï¼ˆå³â†’å·¦ï¼Œä¸å«è§’ 6ï¼‰
        5, 4, 3, 2, 1, 0,
        // å·¦é‚Šï¼ˆä¸Šâ†’ä¸‹ï¼Œä¸å«è§’ 0ã€42ï¼‰
        7, 14, 21, 28, 35
    ];
    const TOTAL_CELLS = boardPath.length;

    // --- æ“´å……å¾Œçš„äº‹ä»¶ç‰Œåº« ---
    const eventDeck = [
        // --- å¸‚å ´äº‹ä»¶ ---
        {
            type: 'market', title: 'ã€ç¾ä»£ã€‘ç§‘æŠ€å¥‡è¹Ÿ', desc: 'è¼é”(NVIDIA)åŸ·è¡Œé•·é»ƒä»å‹³ç©¿è‘—è“®è‘‰ä»¿ç”Ÿçš®è¡£é–‹ç™¼å¸ƒæœƒï¼Œå®£å¸ƒé«˜åƒ¹æ”¶è³¼è“®è‘‰ä½œç‚ºAIæ™¶ç‰‡æ•£ç†±ææ–™ã€‚', result: 'è“®èŠ±æ¦‚å¿µè‚¡ä¸€é£›è¡å¤©ï¼è“®èŠ±åƒ¹æ ¼é£†æ¼² 50%ï¼', action: (market) => {
                market.prices.lotus = Math.max(1, Math.round(market.prices.lotus * 1.5));
            }
        },
        { type: 'market', title: 'ã€ç¾ä»£ã€‘æ–‡åŒ–æ½®æµ', desc: 'å®®å»·åŠ‡ã€Šåœ‹è‰²å¤©é¦™ã€‹æˆç‚ºå¹´åº¦çˆ†æ¬¾ï¼ŒåŠ‡ä¸­ã€Œå”¯æœ‰ç‰¡ä¸¹çœŸåœ‹è‰²ã€å°è©çˆ†ç´…ï¼Œå…¨åœ‹æ€èµ·ç‰¡ä¸¹ç†±æ½®ã€‚', result: 'ç‰¡ä¸¹è²·æ°£å¤§å¢ï¼Œåƒ¹æ ¼ä¸Šæ¼² 30%ï¼', action: (market) => { market.prices.peony = Math.max(1, Math.round(market.prices.peony * 1.3)); } },
        { type: 'market', title: 'ã€å¤ä»£ã€‘æ¯é…’é‡‹å…µæ¬Š', desc: 'ä½ ç©¿è¶Šåˆ°å®‹ä»£ä¸€å ´å®´æœƒï¼Œè¶™åŒ¡èƒ¤æš—ç¤ºå°‡é ˜å€‘å‘Šè€é‚„é„‰ï¼Œä¸¦è³è³œèŠèŠ±é…’ã€‚ã€Œæ™šç¯€ã€èˆ‡ã€Œéš±é€€ã€çš„è±¡å¾µæ„ç¾©æ·±å…¥äººå¿ƒã€‚', result: 'èŠèŠ±åƒ¹å€¼è¢«é‡æ–°å®šç¾©ï¼Œåƒ¹æ ¼æš´æ¼² 40%ï¼', action: (market) => { market.prices.chrys = Math.max(1, Math.round(market.prices.chrys * 1.4)); } },
        { type: 'market', title: 'ã€å¤ä»£ã€‘å—æ–¹å¤§æ—±', desc: 'æ™‚å€¼å®‹ä»å®—æ˜é“äºŒå¹´ï¼Œå—æ–¹å¤§æ—±ï¼Œè“®èŠ±æ± ä¹¾æ¶¸è¦‹åº•ï¼Œç”¢é‡éŠ³æ¸›ã€‚ç„¶è€Œï¼Œè€å„²è—çš„è“®å­å»å› é¥‘è’è€Œæˆç‚ºçè²´é£Ÿç³§ã€‚', result: 'è“®èŠ±ä¾›çµ¦éŠ³æ¸›ï¼Œåƒ¹æ ¼é£†æ¼² 60%ï¼', action: (market) => { market.prices.lotus = Math.max(1, Math.round(market.prices.lotus * 1.6)); } },
        { type: 'market', title: 'ã€ç¾ä»£ã€‘æ™‚ç¯€éœ€æ±‚', desc: 'é‡é™½ç¯€å°‡è‡³ï¼Œç™»é«˜ã€è³èŠã€é£²èŠèŠ±é…’æˆç‚ºç†±é–€æ´»å‹•ï¼Œå„å¤§é¤Šç”ŸèŒ¶å“ç‰Œç´›ç´›æ¨å‡ºèŠèŠ±ç›¸é—œç”¢å“ã€‚', result: 'èŠèŠ±éœ€æ±‚å¤§å¢ï¼Œåƒ¹æ ¼ä¸Šæ¼² 25%ï¼', action: (market) => { market.prices.chrys = Math.max(1, Math.round(market.prices.chrys * 1.25)); } },
        { type: 'market', title: 'ã€å¸‚å ´ã€‘ä¾›æ‡‰éå‰©', desc: 'ä»Šå¹´æ°£å€™æ¥µä½³ï¼Œç‰¡ä¸¹èŠ±ç”¢é‡å‰µä¸‹æ­·å²æ–°é«˜ï¼Œå¸‚å ´ä¸Šä¾›éæ–¼æ±‚ã€‚', result: 'ç‰¡ä¸¹åƒ¹æ ¼ä¸‹è·Œ 20%ã€‚', action: (market) => { market.prices.peony = Math.max(1, Math.round(market.prices.peony * 0.8)); } },
        { type: 'market', title: 'ã€å¤ä»£ã€‘åå¦ƒç”Ÿæ—¥', desc: 'å®®ä¸­ç‚ºè²´å¦ƒæ…¶ç”Ÿï¼Œä¸‹ä»¤æ¡è³¼å¤§é‡ç‰¡ä¸¹è£é£¾å®®æ®¿ï¼Œä¸€æ™‚ä¹‹é–“ã€Œæ´›é™½ç´™è²´ï¼Œé•·å®‰èŠ±è²´ã€ã€‚', result: 'ç‰¡ä¸¹éœ€æ±‚æ¿€å¢ï¼Œåƒ¹æ ¼ä¸Šæ¼² 35%ï¼', action: (market) => { market.prices.peony = Math.max(1, Math.round(market.prices.peony * 1.35)); } },
        { type: 'market', title: 'ã€å¤ä»£ã€‘ç˜Ÿç–«ç§˜æ–¹', desc: 'å®‹çœŸå®—å¹´é–“å…©æµ™å‡ºç¾ç˜Ÿç–«ï¼Œå®‰æ¨‚åŠç™¼ç¾è“®å­èŠ¯æœ‰å¥‡æ•ˆï¼Œå°‡å…¶åŠ å…¥ã€Œè–æ•£å­ã€ç§˜æ–¹ä¸­ï¼Œæœå»·ä¸‹ä»¤å¤§é‡æ”¶è³¼ã€‚', result: 'è“®èŠ±å› å…¶è—¥ç”¨åƒ¹å€¼è¢«è¿½æ§ï¼Œåƒ¹æ ¼å¤§æ¼² 40%ï¼', action: (market) => { market.prices.lotus = Math.max(1, Math.round(market.prices.lotus * 1.4)); } },
        { type: 'market', title: 'ã€å¸‚å ´ã€‘æ³¡æ²«ç ´è£‚', desc: 'å‰é™£å­è¢«ç‚’ä½œåˆ°å¤©åƒ¹çš„ã€Œé¬±é‡‘é¦™ã€æ³¡æ²«çªç„¶ç ´è£‚ï¼Œææ…Œæƒ…ç·’è”“å»¶åˆ°æ•´å€‹èŠ±å‰å¸‚å ´ã€‚', result: 'æ‰€æœ‰èŠ±å‰åƒ¹æ ¼ææ…Œæ€§ä¸‹è·Œ 15%ã€‚', action: (market) => { for (const flower in market.prices) { market.prices[flower] = Math.max(1, Math.round(market.prices[flower] * 0.85)); } } },

        // --- éå¸‚å ´äº‹ä»¶ ---
        { type: 'knowledge', title: 'ã€å¥‡é‡ã€‘é‡è¦‹é™¶æ·µæ˜', desc: 'åœ¨æ±ç±¬ä¸‹ï¼Œä½ é‡è¦‹ä¸€ä½æ¡èŠçš„éš±å£«ï¼Œä»–å•ä½ ï¼šã€ŒèŠ±ä¸­å›å­å›ºç„¶å¯æ•¬ï¼Œä½†è‹¥èƒ½æ‚ ç„¶è‡ªå¾—ï¼Œä¸ä¹Ÿæ˜¯ä¸€ç¨®äººç”Ÿå—ï¼Ÿã€', choices: [{ text: 'ã€Œå…ˆç”Ÿèªªçš„æ˜¯ï¼Œè‡ªåœ¨æœ€é›£å¾—ã€‚ã€', effect: (player) => { player.attributes.chrys += 15; player.exp += 10; player.creativity += 5; return "è‡ªåœ¨+15, ç¶“é©—+10, æ–‡æ€+5"; } }, { text: 'ã€Œä½†æˆ‘èªç‚ºå…¥ä¸–æ”¹è®Šæ›´é‡è¦ã€‚ã€', effect: (player) => { player.attributes.lotus += 10; player.attributes.chrys -= 5; player.exp += 5; return "è‡ªå®ˆ+10, è‡ªåœ¨-5, ç¶“é©—+5"; } },] },
        { type: 'interpersonal', title: 'ã€äººéš›ã€‘æœ‹å‹çš„ç‚«è€€', desc: 'ä½ çš„æœ‹å‹è²·äº†æœ€æ–°çš„åç‰ŒåŒ…ï¼Œèˆˆå¥®åœ°å‘ä½ å±•ç¤ºï¼Œä¸¦èªªï¼šã€Œäººé‚„æ˜¯è¦æ‡‚å¾—çŠ’è³è‡ªå·±ï¼Œæ´»å‡ºå…‰å½©ï¼ã€', choices: [{ text: 'ã€Œå¤ªæ£’äº†ï¼é€™å®Œå…¨æ˜¯ä½ çš„é¢¨æ ¼ï¼ã€', effect: (player) => { player.attributes.peony += 10; player.money -= 50; return "ä½ è«‹ä»–å–äº†æ¯é£²æ–™æ…¶ç¥ã€‚æ¦®è€€+10, èŠ±å¹£-50"; } }, { text: 'ã€Œå¾ˆç¾ï¼Œä½†æˆ‘è¦ºå¾—å…§åœ¨å……å¯¦æ›´å¿«æ¨‚ã€‚ã€', effect: (player) => { player.attributes.lotus += 10; player.attributes.peony -= 5; player.exp += 5; return "è‡ªå®ˆ+10, æ¦®è€€-5, ç¶“é©—+5"; } }, { text: 'ã€Œåªè¦ä½ é–‹å¿ƒå°±å¥½ã€‚ã€', effect: (player) => { player.attributes.chrys += 5; return "è‡ªåœ¨+5"; } }] },

        /*
        // --- ğŸ”´ å·²ä¿®å¾©ï¼šè¨»è§£æ‰é‡è¤‡çš„ã€Œéˆå…‰ä¸€é–ƒã€äº‹ä»¶ ---
        { type: 'creation', title: 'ã€å‰µä½œã€‘éˆå…‰ä¸€é–ƒ', desc: 'ä½ æ¼«æ­¥æ¹–é‚Šï¼Œçœ‹åˆ°è“®èŠ±äº­äº­æ·¨æ¤çš„æ¨¡æ¨£ï¼Œå¿ƒä¸­æ¹§ç¾ä¸€è‚¡å‰µä½œçš„è¡å‹•ã€‚ä½ æƒ³è¨˜ä¸‹ä»€éº¼ï¼Ÿ', choices: [{ text: 'æå¯«å®ƒçš„å½¢æ…‹ï¼šã€Œä¸­é€šå¤–ç›´ï¼Œä¸è”“ä¸æã€', effect: (player) => { player.creativity += 15; player.exp += 5; return "æ–‡æ€+15, ç¶“é©—+5"; } }, { text: 'æŠ’ç™¼å®ƒçš„å“æ ¼ï¼šã€Œé¦™é ç›Šæ¸…ï¼Œå¯é è§€è€Œä¸å¯è¤»ç©ã€', effect: (player) => { player.creativity += 10; player.attributes.lotus += 5; return "æ–‡æ€+10, è‡ªå®ˆ+5"; } }] },
        */

        { type: 'character', title: 'ã€å“æ ¼ã€‘æ¸…å»‰é¢¨æ½®', desc: 'æœä¸­å¾¡å²ç™¼èµ·ç¯€å„‰é‹å‹•ï¼Œæå€¡æ¸…å»‰ï¼Œä»¥ä½©æˆ´è“®èŠ±ç‚ºé¢¨å°šï¼Œå¥¢è¯çš„ç‰¡ä¸¹å‰‡å—åˆ°å†·è½ã€‚', choices: [{ text: 'éŸ¿æ‡‰è™Ÿå¬ï¼Œæ‹‹å”®ç‰¡ä¸¹ï¼Œè²·å…¥è“®èŠ±ã€‚', effect: (player) => { player.attributes.lotus += 15; player.attributes.peony -= 5; player.exp += 10; return "è‡ªå®ˆ+15, æ¦®è€€-5, ç¶“é©—+10"; } }, { text: 'èªç‚ºé€™åªæ˜¯ä¸€æ™‚é¢¨æ½®ï¼Œä¸ç‚ºæ‰€å‹•ã€‚', effect: (player) => { player.attributes.chrys += 10; return "è‡ªåœ¨+10"; } }] },
        { type: 'interpersonal', title: 'ã€äººéš›ã€‘åŒå„•çš„å£“åŠ›', desc: 'åŒå­¸å€‘éƒ½åœ¨è¨è«–æœ€æ–°çš„æµè¡Œè¶¨å‹¢ï¼Œä¸¦å˜²ç¬‘ä½ çš„é¢¨æ ¼æœ‰äº›éæ™‚ã€‚', choices: [{ text: 'èŠ±éŒ¢è·Ÿä¸Šæ½®æµï¼Œèå…¥å¤§å®¶ã€‚', effect: (player) => { player.money -= 100; player.attributes.peony += 10; return "èŠ±å¹£-100, æ¦®è€€+10"; } }, { text: 'å …æŒè‡ªå·±çš„é¢¨æ ¼ï¼Œä¸äºˆç†æœƒã€‚', effect: (player) => { player.attributes.lotus += 10; player.exp += 5; return "è‡ªå®ˆ+10, ç¶“é©—+5"; } }] },

        /*
        // --- ğŸ”´ å·²ä¿®å¾©ï¼šè¨»è§£æ‰é‡è¤‡çš„ã€Œé‡è¦‹å‘¨æ•¦é ¤ã€äº‹ä»¶ ---
        { type: 'knowledge', title: 'ã€å¥‡é‡ã€‘é‡è¦‹å‘¨æ•¦é ¤', desc: 'ä½ åœ¨æ¿‚æºªæ›¸é™¢æ—çœ‹åˆ°ä¸€ä½å…ˆç”Ÿæ­£åœ¨å‡è¦–æ± ä¸­è“®èŠ±ï¼Œä»–æ„Ÿå˜†é“ï¼šã€ŒèŠï¼ŒèŠ±ä¹‹éš±é€¸è€…ä¹Ÿï¼›ç‰¡ä¸¹ï¼ŒèŠ±ä¹‹å¯Œè²´è€…ä¹Ÿï¼›è“®ï¼ŒèŠ±ä¹‹å›å­è€…ä¹Ÿã€‚ã€', choices: [{ text: 'ä¸Šå‰è¡Œç¦®ï¼Œä¸¦è´ˆä¸Šä¸€æŸè“®èŠ±ã€‚', effect: (player) => { player.creativity += 15; player.exp += 15; player.attributes.lotus += 10; return "èˆ‡å…ˆè³¢äº¤æµï¼Œæ–‡æ€+15, ç¶“é©—+15, è‡ªå®ˆ+10"; } }, { text: 'é»˜é»˜é›¢é–‹ï¼Œä¸å»æ‰“æ“¾ã€‚', effect: (player) => { player.attributes.chrys += 5; return "è‡ªåœ¨+5"; } }] },
        */

        { type: 'creation', title: 'ã€å‰µä½œã€‘ç«‹æ„ä¸æ˜', desc: 'ä½ æ­£åœ¨æ§‹æ€ä¸€ç¯‡ã€Œæ„›ï¼¯èªªã€ï¼Œä½†å°æ–¼è¦è®šé Œçš„ä¸»é¡Œå“æ ¼æ„Ÿåˆ°è¿·æƒ˜ã€‚', choices: [{ text: 'é¸æ“‡ä¸€å€‹å¤§çœ¾è¨å–œçš„ä¸»é¡Œä¾†å¯«ã€‚', effect: (player) => { player.attributes.peony += 5; player.creativity -= 5; return "æ¦®è€€+5, ä½†æ–‡æ€-5"; } }, { text: 'å¿ æ–¼å…§å¿ƒï¼Œé¸æ“‡ä¸€å€‹å†·é–€ä½†è‡ªå·±çœŸæ­£å–œæ„›çš„ä¸»é¡Œã€‚', effect: (player) => { player.creativity += 10; player.attributes.lotus += 5; return "æ–‡æ€+10, è‡ªå®ˆ+5"; } }] }
    ];

    // === â¬‡ï¸ æ–°å¢ï¼šæ“´å……äº‹ä»¶ç‰Œåº«ï¼ˆå®Œå…¨ä¸æ”¹ä½ çš„åŸæœ¬ eventDeckï¼‰ ===
    const extraEvents = [
        // â€”â€” ä¸‹åˆ—äº‹ä»¶çš†ç‚ºæ–°å¢ï¼Œä¸”ä¸èˆ‡ä½ ç¾æœ‰ title é‡å â€”â€”
        {
            type: 'interpersonal', title: 'èŠ±å¸‚ç››æœƒ', desc: 'èŠ±å¸‚é¼æ²¸ï¼Œè²´æ—é‡é‡‘æ”¶ç‰¡ä¸¹ï¼Œé‚€ä½ å±•ç¤ºæ ½åŸ¹æˆæœã€‚', choices: [
                {
                    text: 'æŠ“ä½æ©Ÿæœƒï¼Œè³£å‡ºæ‰€æœ‰ç‰¡ä¸¹ï¼', effect: (p) => {
                        const gain = 300 + Math.floor(Math.random() * 200);
                        p.money = (p.money | 0) + gain;
                        p.attributes.peony = Math.min(100, (p.attributes.peony | 0) + 5);
                        p.exp = (p.exp | 0) + 1;
                        p.inventory.peony = 0;
                        return `ä½ æœæ–·å‡ºæ‰‹ï¼Œè³ºå¾— ${gain} èŠ±å¹£ï¼Œçœ¾äººç¨±ä½ çœ¼å…‰ç¨åˆ°ã€‚`;
                    }
                },
                {
                    text: 'æ‹’çµ•ç‚«è€€ï¼Œç•™çµ¦çœŸæ­£æ‡‚èŠ±çš„äººã€‚', effect: (p) => {
                        p.attributes.lotus = Math.min(100, (p.attributes.lotus | 0) + 5);
                        p.creativity = (p.creativity | 0) + 2;
                        return 'ä½ ä¸ç‚ºåˆ©ç›Šæ‰€å‹•ï¼Œè²´æ—å¾®ç¬‘é›¢é–‹ï¼Œä½†ä½ å¿ƒä¸­æ›´ç¯¤å®šäº†ã€‚';
                    }
                },
            ]
        },

        {
            type: 'interpersonal', title: 'è™›åä¹‹å®´', desc: 'åæµå®´ä¸Šï¼Œäººäººèª‡è€€èŠ±åœ’ä¹‹ç››ï¼Œå°‘äººè«‡èŠ±ä¹‹æ€§ã€‚æœ‰äººè¦ä½ èª‡å£ä»¥åšæŒè²ã€‚', choices: [
                {
                    text: 'é †å‹¢è€Œç‚ºï¼Œèªªå‡ºæœ€å‹•äººçš„è©å¥ã€‚', effect: (p) => {
                        p.exp = (p.exp | 0) + 2;
                        p.attributes.peony = Math.min(100, (p.attributes.peony | 0) + 3);
                        p.creativity = (p.creativity | 0) + 1;
                        return 'æ»¿å ‚å–é‡‡ï¼Œä½†ä½ æ„Ÿåˆ°äº›è¨±ç©ºæ´ã€‚';
                    }
                },
                {
                    text: 'ä¿æŒæ²‰é»˜ï¼Œè®“èŠ±è‡ªå·±èªªè©±ã€‚', effect: (p) => {
                        p.attributes.lotus = Math.min(100, (p.attributes.lotus | 0) + 4);
                        return 'ä½ çš„éœé»˜æ¯”åƒè¨€æ›´æ·±ï¼Œå¹¾äººé–‹å§‹é‡æ–°å¯©è¦–æ‰‹ä¸­çš„èŠ±ã€‚';
                    }
                },
            ]
        },

        {
            type: 'character', title: 'æ¿æ°´ä¹‹æ± ', desc: 'é€£æ—¥é™°é›¨ï¼Œè“®æ± æ··æ¿ã€‚åœ’ä¸è«‹ä½ å”åŠ›æ¸…ç†é›œè‰ã€‚', choices: [
                {
                    text: 'æŒ½è¢–åŒå·¥ï¼Œç¶­è­·è“®æ± ä¹‹æ¸…ã€‚', effect: (p) => {
                        p.exp = (p.exp | 0) + 3;
                        p.attributes.lotus = Math.min(100, (p.attributes.lotus | 0) + 5);
                        p.money = Math.max(0, (p.money | 0) - 50);
                        return 'ä½ ä¸è¨ˆé…¬å‹ï¼Œæ¸…å‡ºæ»¿æ± æ–°ç¶ ã€‚è¡£è¢–æŸ“æ³¥ï¼Œå»ä¹ŸæŸ“ä¸Šå…‰ã€‚';
                    }
                },
                {
                    text: 'å©‰æ‹’å¹«å¿™ï¼Œé€™ä¸æ˜¯ä½ çš„è²¬ä»»ã€‚', effect: (p) => {
                        p.attributes.peony = Math.min(100, (p.attributes.peony | 0) + 2);
                        return 'ä½ é¸æ“‡ä¿ç•™åŠ›é‡ï¼Œä½†æ—äººæŠ•ä¾†è¤‡é›œçš„ç›®å…‰ã€‚';
                    }
                },
            ]
        },

        {
            type: 'character', title: 'æ¸…é¢¨é›£ç•™', desc: 'æœ‰äººæŠ„è¥²ä½ çš„è©©å¥è€Œå¾—åï¼Œä½ è©²æ­ç™¼å—ï¼Ÿ', choices: [
                {
                    text: 'æ­ç™¼çœŸç›¸ï¼Œç¶­è­·å…¬é“ã€‚', effect: (p) => {
                        p.attributes.peony = Math.min(100, (p.attributes.peony | 0) + 4);
                        p.exp = (p.exp | 0) + 1;
                        return 'ä½ å‹‡æ–¼ç›´è¨€ï¼ŒçœŸç›¸æ¼¸æ˜ï¼Œä½†ä¹Ÿå¤šäº†ä¸€å€‹æ•µäººã€‚';
                    }
                },
                {
                    text: 'é¸æ“‡æ²‰é»˜ï¼Œè®“æ™‚é–“èªªè©±ã€‚', effect: (p) => {
                        p.attributes.lotus = Math.min(100, (p.attributes.lotus | 0) + 5);
                        p.creativity = (p.creativity | 0) + 3;
                        return 'ä½ è½‰èº«é›¢å»ï¼Œåœ¨æ–°çš„è©©ç¯‡è£¡æ‰¾å›äº†è‡ªå·±ã€‚';
                    }
                },
            ]
        },

        {
            type: 'knowledge', title: 'ç§‹å±±é‚€ç´„', desc: 'å‹äººé‚€ä½ å…¥å±±è³èŠï¼Œè·¯é ä¸”è²»æ™‚ã€‚æ˜¯å¦å‰å¾€ï¼Ÿ', choices: [
                {
                    text: 'å‰å¾€å±±ä¸­å°‹èŠ³ã€‚', effect: (p) => {
                        p.attributes.chrys = Math.min(100, (p.attributes.chrys | 0) + 5);
                        p.creativity = (p.creativity | 0) + 4;
                        return 'å±±é¢¨æ‹‚é¢ï¼Œä½ åœ¨å¯‚éœä¸­é ˜æ‚Ÿæ™‚é–“çš„ç·©æ…¢ã€‚';
                    }
                },
                {
                    text: 'å©‰æ‹’é‚€è«‹ï¼Œç•™å®ˆå¸‚å ´ã€‚', effect: (p) => {
                        p.money = (p.money | 0) + 100;
                        p.attributes.peony = Math.min(100, (p.attributes.peony | 0) + 3);
                        return 'ä½ é¸æ“‡å‹™å¯¦ï¼Œè³ºå¾—ä¸€äº›éŒ¢ï¼Œä½†éŒ¯éä¸€å ´å¿ƒéˆæ—…è¡Œã€‚';
                    }
                },
            ]
        },

        {
            type: 'creation', title: 'è½èŠ±ä¸æ­¸', desc: 'ä¸€å¤œç§‹é›¨ï¼ŒèŠ±ç“£æ»¿åœ°ã€‚ä½ æ˜¯å¦è¦é‡æ–°ç¨®ä¸‹å®ƒå€‘ï¼Ÿ', choices: [
                {
                    text: 'é‡æ¤å¸Œæœ›ã€‚', effect: (p) => {
                        p.exp = (p.exp | 0) + 2;
                        p.creativity = (p.creativity | 0) + 2;
                        return 'ä½ æ‹¾èŠ±æ’­ç¨®ã€‚æ–°ç”Ÿçš„åŠ›é‡æ‚„æ‚„èŒèŠ½ã€‚';
                    }
                },
                {
                    text: 'éœè§€è‡ªç„¶ä¹‹é“ã€‚', effect: (p) => {
                        p.attributes.chrys = Math.min(100, (p.attributes.chrys | 0) + 5);
                        return 'ä½ æ˜ç™½å‡‹é›¶äº¦æ˜¯é¢¨æ™¯ã€‚å¿ƒå¢ƒæ›´å¯¬ã€‚';
                    }
                },
            ]
        },

        {
            type: 'knowledge', title: 'æ¿‚æºªä¸€å•', desc: 'æ›¸é™¢æ—ï¼Œå…ˆç”Ÿå‡è¦–æ± ä¸­è“®èŠ±ï¼šã€ŒèŠï¼ŒèŠ±ä¹‹éš±é€¸è€…ä¹Ÿï¼›ç‰¡ä¸¹ï¼ŒèŠ±ä¹‹å¯Œè²´è€…ä¹Ÿï¼›è“®ï¼ŒèŠ±ä¹‹å›å­è€…ä¹Ÿã€‚ã€', choices: [
                {
                    text: 'ä¸Šå‰è‡´æ„ï¼Œè´ˆä¸€æŸè“®èŠ±ã€‚', effect: (p) => {
                        p.creativity = (p.creativity | 0) + 15;
                        p.exp = (p.exp | 0) + 15;
                        p.attributes.lotus = Math.min(100, (p.attributes.lotus | 0) + 10);
                        return 'èˆ‡å…ˆè³¢è«–é“ï¼Œæ–‡æ€+15ã€ç¶“é©—+15ã€è‡ªå®ˆ+10ã€‚';
                    }
                },
                {
                    text: 'é»˜é»˜é›¢é–‹ï¼Œä¸å»æ‰“æ“¾ã€‚', effect: (p) => {
                        p.attributes.chrys = Math.min(100, (p.attributes.chrys | 0) + 5);
                        return 'ä½ å°Šé‡éœé»˜ã€‚è‡ªåœ¨+5ã€‚';
                    }
                },
            ]
        },

        {
            type: 'creation', title: 'éˆå…‰ä¸€é–ƒ', desc: 'ä½ æ¼«æ­¥æ¹–é‚Šï¼Œè¦‹è“®äº­äº­æ·¨æ¤ï¼Œå¿ƒç”Ÿå‰µä½œè¡å‹•ã€‚', choices: [
                {
                    text: 'å¯«å…¶å½¢ï¼šã€Œä¸­é€šå¤–ç›´ï¼Œä¸è”“ä¸æã€', effect: (p) => {
                        p.creativity = (p.creativity | 0) + 15;
                        p.exp = (p.exp | 0) + 5;
                        return 'æ–‡æ€+15ã€ç¶“é©—+5ã€‚';
                    }
                },
                {
                    text: 'å¯«å…¶å¾·ï¼šã€Œé¦™é ç›Šæ¸…ï¼Œå¯é è§€è€Œä¸å¯è¤»ç©ã€', effect: (p) => {
                        p.creativity = (p.creativity | 0) + 10;
                        p.attributes.lotus = Math.min(100, (p.attributes.lotus | 0) + 5);
                        return 'æ–‡æ€+10ã€è‡ªå®ˆ+5ã€‚';
                    }
                },
            ]
        },


        // =================================================================
        // ============ ğŸ’ æ·±åº¦æ–‡åŒ–èˆ‡æ­·å²äº‹ä»¶æ¨¡çµ„ (Gemini æ’°å¯«) =============
        // =================================================================

        // äº‹ä»¶ 1: ç¨‹é¡¥ã€ç¨‹é ¤çš„å“²å­¸å°è©±
        {
            type: 'knowledge',
            title: 'ã€ç†å­¸ä¹‹é“ã€‘æ˜¥æ—¥è§€æ™¯',
            desc: 'ä½ èˆ‡ç¨‹é–€å…©å…„å¼Ÿä¸€åŒæ˜¥éŠã€‚å“¥å“¥ç¨‹é¡¥æŒ‡è‘—ç”Ÿæ„ç›ç„¶çš„è‰æœ¨èªªï¼šã€Œè¬ç‰©çš†æœ‰ç”Ÿæ„ï¼Œèˆ‡æˆ‘å¿ƒç‚ºä¸€é«”ã€‚ã€å¼Ÿå¼Ÿç¨‹é ¤å»èªªï¼šã€Œéœ€éœå¿ƒè§€å¯Ÿï¼Œæ–¹èƒ½çª®ç©¶å…¶èƒŒå¾Œä¹‹ã€ç†ã€ã€‚ã€',
            choices: [
                {
                    text: 'èªåŒç¨‹é¡¥ï¼šã€Œæ„Ÿå—è¬ç‰©å’Œè«§ï¼Œå…§å¿ƒè‡ªå¾—åœ“æ»¿ã€‚ã€',
                    effect: (p) => {
                        p.attributes.chrys += 15;
                        p.creativity += 10;
                        return 'ä½ é ˜æ‚Ÿäº†é †æ‡‰è‡ªç„¶ã€èˆ‡è¬ç‰©åŒæ¨‚çš„å¿ƒå¢ƒã€‚è‡ªåœ¨+15ã€æ–‡æ€+10ã€‚';
                    }
                },
                {
                    text: 'èªåŒç¨‹é ¤ï¼šã€Œä»”ç´°è§€å¯Ÿç ”ç©¶ï¼Œæ‰èƒ½ç™¼ç¾äº‹ç‰©é‹ä½œçš„é“ç†ã€‚ã€',
                    effect: (p) => {
                        p.attributes.lotus += 15;
                        p.exp += 10;
                        return 'ä½ å­¸æœƒäº†å‡¡äº‹æ¢æ±‚æ ¹æœ¬ã€åš´è¬¹å°å¾…çš„æ…‹åº¦ã€‚è‡ªå®ˆ+15ã€ç¶“é©—+10ã€‚';
                    }
                }
            ]
        },

        // äº‹ä»¶ 2: å‘¨æ•¦é ¤çš„äººç”ŸæŠ‰æ“‡
        {
            type: 'character',
            title: 'ã€æ¿‚æºªé¢¨éª¨ã€‘é æ–¹çš„å®˜è·',
            desc: 'å‘¨æ•¦é ¤å…ˆç”Ÿæ”¶åˆ°ä¸€ä»½ä»»å‘½ï¼Œå¯ä»¥å»ä¸€å€‹å¯Œåº¶ä½†å®˜å ´è¤‡é›œçš„åœ°æ–¹ç•¶å®˜ã€‚ä»–å»é¸æ“‡äº†ä¸€å€‹åé ã€æ¸…è‹¦ä½†èƒ½å°ˆå¿ƒæ²»å­¸çš„åœ°æ–¹ã€‚',
            choices: [
                {
                    text: 'ã€Œå…ˆç”Ÿé¢¨éª¨ï¼Œæ­£æ˜¯æˆ‘è¼©æ¥·æ¨¡ã€‚ã€',
                    effect: (p) => {
                        p.attributes.lotus += 20;
                        p.creativity += 5;
                        return 'ä½ å°ã€Œå›å­ã€çš„ç†è§£æ›´æ·±ä¸€å±¤ï¼Œä¸ç‚ºååˆ©æ‰€å‹•ã€‚è‡ªå®ˆ+20ã€æ–‡æ€+5ã€‚';
                    }
                },
                {
                    text: 'ã€Œé›–æ•¬ä½©ï¼Œä½†å…¥ä¸–ã€åœ¨é‡è¦çš„ä½ç½®ä¸Šæ‰èƒ½æ”¹è®Šæ›´å¤šã€‚ã€',
                    effect: (p) => {
                        p.attributes.peony += 10;
                        p.exp += 5;
                        return 'ä½ èªç‚ºåœ¨æ›´é‡è¦çš„ä½ç½®ä¸Šç™¼æ®å½±éŸ¿åŠ›ï¼Œä¹Ÿæ˜¯ä¸€ç¨®é¸æ“‡ã€‚æ¦®è€€+10ã€ç¶“é©—+5ã€‚';
                    }
                }
            ]
        },

        // äº‹ä»¶ 3: æ¾¶æ·µä¹‹ç›Ÿçš„æ­·å²åæ€
        {
            type: 'knowledge',
            title: 'ã€æ­·å²ä¹‹é‘‘ã€‘æ¾¶æ·µä¹‹ç›Ÿ',
            desc: 'å²æ›¸è¨˜è¼‰ï¼Œå®‹çœŸå®—èˆ‡é¼åœ‹ç°½è¨‚ã€Œæ¾¶æ·µä¹‹ç›Ÿã€ï¼Œç”¨é‡‘éŒ¢æ›å–äº†ç™¾å¹´çš„å’Œå¹³ã€‚å¾Œäººå°æ­¤è©•åƒ¹ä¸ä¸€ã€‚',
            choices: [
                {
                    text: 'ã€Œé€™æ˜¯å±ˆè¾±çš„åˆç´„ï¼Œæ‡‰å¥®æˆ°åˆ°åº•ã€‚ã€',
                    effect: (p) => {
                        p.attributes.lotus += 15;
                        p.attributes.peony -= 5;
                        return 'ä½ èªç‚ºåœ‹å®¶çš„å°Šåš´é«˜æ–¼ä¸€åˆ‡ï¼Œå …æŒåŸå‰‡ä¸å®¹å¦¥å”ã€‚è‡ªå®ˆ+15ã€æ¦®è€€-5ã€‚';
                    }
                },
                {
                    text: 'ã€Œé€™æ˜¯å‹™å¯¦çš„æ™ºæ…§ï¼Œè®“ç™¾å§“å…æ–¼æˆ°ç«ã€‚ã€',
                    effect: (p) => {
                        p.attributes.peony += 10;
                        p.exp += 10;
                        return 'ä½ èªç‚ºå®ˆè­·äººæ°‘çš„å®‰å¯§æ˜¯æ›´é‡è¦çš„æˆå°±ã€‚æ¦®è€€+10ã€ç¶“é©—+10ã€‚';
                    }
                }
            ]
        },

        // äº‹ä»¶ 4: é‡æ–‡è¼•æ­¦çš„æ”¿ç­–æ€è¾¨
        {
            type: 'character',
            title: 'ã€å¸åœ‹åŸºçŸ³ã€‘æ¯é…’é‡‹å…µæ¬Š',
            desc: 'ä½ ç©¿è¶Šå›ä¸€å ´å®´å¸­ï¼Œå®‹å¤ªç¥–è¶™åŒ¡èƒ¤æº«å’Œåœ°å‹¸èªªå¤§å°‡å€‘äº¤å‡ºå…µæ¬Šï¼Œå›å®¶å®‰äº«å¯Œè²´ï¼Œä»¥æ­¤å¥ å®šã€Œé‡æ–‡è¼•æ­¦ã€çš„åœ‹ç­–ã€‚',
            choices: [
                {
                    text: 'ã€Œé€™æ˜¯é«˜æ˜çš„æ”¿æ²»æ‰‹è…•ï¼Œé¿å…äº†å…§äº‚ã€‚ã€',
                    effect: (p) => {
                        p.creativity += 15;
                        p.exp += 10;
                        return 'ä½ è®šè³é€™ç¨®ä»¥æ™ºæ…§åŒ–è§£è¡çªçš„æ–¹å¼ï¼Œåœ‹å®¶å¾æ­¤å®‰å®šã€‚æ–‡æ€+15ã€ç¶“é©—+10ã€‚';
                    }
                },
                {
                    text: 'ã€Œé€™ä¹ŸåŸ‹ä¸‹äº†æ—¥å¾Œè»äº‹ç©å¼±çš„éš±æ‚£ã€‚ã€',
                    effect: (p) => {
                        p.attributes.lotus += 10;
                        p.exp += 5;
                        return 'ä½ çœ‹åˆ°äº†æ”¿ç­–èƒŒå¾Œ long é çš„ä»£åƒ¹ï¼Œæ€è€ƒæ›´ç‚ºå‘¨å…¨ã€‚è‡ªå®ˆ+10ã€ç¶“é©—+5ã€‚';
                    }
                }
            ]
        },

        // äº‹ä»¶ 5: ç‹å®‰çŸ³è®Šæ³•çš„å›°å¢ƒ
        {
            type: 'social',
            title: 'ã€æ”¹é©ä¹‹è·¯ã€‘ç‹å®‰çŸ³è®Šæ³•',
            desc: 'ä½ é‡åˆ°æ¨è¡Œæ–°æ³•çš„å®˜å“¡ï¼Œä»–æ„Ÿå˜†ï¼šã€Œæ–°æ³•é›–èƒ½å¯Œåœ‹å¼·å…µï¼Œå»è§¸å‹•äº†è¨±å¤šèˆŠæ¬Šè²´çš„åˆ©ç›Šï¼Œæ¨è¡Œé˜»åŠ›é‡é‡ã€‚ã€',
            choices: [
                {
                    text: 'ã€Œç‚ºåœ‹ç‚ºæ°‘ï¼Œæ‡‰ç•¶ä¸ç•è‰±éšªï¼Œå …æŒåˆ°åº•ã€‚ã€',
                    effect: (p) => {
                        p.attributes.lotus += 15;
                        p.exp += 10;
                        return 'ä½ ç›¸ä¿¡æ”¹é©çš„å‹‡æ°£èˆ‡æ±ºå¿ƒèƒ½æˆ°å‹ä¸€åˆ‡ã€‚è‡ªå®ˆ+15ã€ç¶“é©—+10ã€‚';
                    }
                },
                {
                    text: 'ã€Œæ”¹é©éœ€å¾ªåºæ¼¸é€²ï¼Œå°‹æ±‚å…±è­˜æ‰èƒ½é•·ä¹…ã€‚ã€',
                    effect: (p) => {
                        p.attributes.peony += 10;
                        p.exp += 5;
                        return 'ä½ èªç‚ºåœ˜çµå¤šæ•¸äººã€å°‹æ±‚å¹³ç©©éæ¸¡æ˜¯æ›´æœ‰æ•ˆçš„ç­–ç•¥ã€‚æ¦®è€€+10ã€ç¶“é©—+5ã€‚';
                    }
                }
            ]
        },

        // äº‹ä»¶ 6: è˜‡è»¾çš„è±é”äººç”Ÿ
        {
            type: 'lifestyle',
            title: 'ã€æ±å¡æ¨‚è§€ã€‘ä¸€è“‘ç…™é›¨',
            desc: 'ä½ é‡åˆ°è¢«è²¶å®˜çš„è˜‡è»¾ï¼Œä»–å»æ¯«ç„¡æ„å®¹ï¼ŒåŸèª¦è‘—ï¼šã€Œä¸€è“‘ç…™é›¨ä»»å¹³ç”Ÿã€‚ã€ä»–å•ä½ ï¼Œé¢å°äººç”Ÿçš„é¢¨é›¨ï¼Œè©²å¦‚ä½•è‡ªè™•ï¼Ÿ',
            choices: [
                {
                    text: 'ã€Œå¦‚æ‚¨ä¸€èˆ¬ï¼Œå®‰ç„¶æ¥å—ï¼Œäº«å—ç•¶ä¸‹ã€‚ã€',
                    effect: (p) => {
                        p.attributes.chrys += 20;
                        p.creativity += 10;
                        return 'ä½ å­¸æœƒäº†åœ¨é€†å¢ƒä¸­å°‹æ‰¾è©©æ„çš„ç”Ÿæ´»æ…‹åº¦ã€‚è‡ªåœ¨+20ã€æ–‡æ€+10ã€‚';
                    }
                },
                {
                    text: 'ã€Œä»è¦ç©æ¥µè¬€åŠƒï¼Œçˆ­å–æ—©æ—¥å›åˆ°æœå ‚ã€‚ã€',
                    effect: (p) => {
                        p.attributes.peony += 15;
                        p.exp += 5;
                        return 'ä½ èªç‚ºä¸æ”¾æ£„å°ä¸–ä¿—æˆå°±çš„è¿½æ±‚ï¼Œä¹Ÿæ˜¯ä¸€ç¨®ç©æ¥µçš„äººç”Ÿã€‚æ¦®è€€+15ã€ç¶“é©—+5ã€‚';
                    }
                }
            ]
        },

        // äº‹ä»¶ 7: èŒƒä»²æ·¹çš„æ†‚æ¨‚å¤©ä¸‹
        {
            type: 'character',
            title: 'ã€å£«äººé¢¨ç¯„ã€‘å…ˆæ†‚å¾Œæ¨‚',
            desc: 'ä½ è½èèŒƒä»²æ·¹å…ˆç”Ÿæ”¾æ£„äº†åœ¨äº¬åŸå®‰é€¸çš„è·ä½ï¼Œä¸»å‹•è«‹çº“å‰å¾€ä¸€å€‹æ­£é­å—å¤©ç½çš„è²§ç˜ ä¹‹åœ°ã€‚ä½ å°æ­¤æœ‰ä½•çœ‹æ³•ï¼Ÿ',
            choices: [
                {
                    text: 'ã€Œè¿½éš¨å…ˆç”Ÿï¼Œå‰å¾€ç½å€ç›¡ä¸€ä»½å¿ƒåŠ›ã€‚ã€',
                    effect: (p) => {
                        p.attributes.lotus += 20;
                        p.exp += 15;
                        p.money = Math.max(0, (p.money | 0) - 100); // æ—…é€”èŠ±è²»
                        return 'ä½ å°‡å€‹äººå®‰å±ç½®ä¹‹åº¦å¤–ï¼Œé¸æ“‡äº†èˆ‡å¤©ä¸‹äººå…±æ‚£é›£çš„é“è·¯ã€‚è‡ªå®ˆ+20ã€ç¶“é©—+15ã€èŠ±å¹£-100ã€‚';
                    }
                },
                {
                    text: 'ã€Œæ•¬ä½©å…¶å¿ƒå¿—ï¼Œä½†æ‡‰å…ˆä¿å…¨è‡ªèº«ã€‚ã€',
                    effect: (p) => {
                        p.attributes.chrys += 10;
                        p.creativity += 5;
                        return 'ä½ èªç‚ºå…ˆè®“è‡ªå·±å¼·å¤§ï¼Œæœªä¾†æ‰æœ‰æ›´å¤šå¹«åŠ©åˆ¥äººçš„å¯èƒ½ã€‚è‡ªåœ¨+10ã€æ–‡æ€+5ã€‚';
                    }
                }
            ]
        }, // <--- âœ¨ å·²åœ¨æ­¤è™•è£œä¸Šè‡³é—œé‡è¦çš„é€—è™Ÿï¼

        // äº‹ä»¶ 8: ä½›å°èˆ‡è˜‡è»¾çš„ç¦ªæ©Ÿ
        {
            type: 'lifestyle',
            title: 'ã€ç¦ªæ©Ÿå¦™èªã€‘ä½›å°ç¦ªå¸«',
            desc: 'ä½ çœ‹åˆ°è˜‡è»¾å°ä½›å°ç¦ªå¸«é–‹ç©ç¬‘èªªï¼šã€Œæˆ‘çœ‹ä½ åƒä¸€å †ç‰›ç³ã€‚ã€ä½›å°ç¦ªå¸«å»å¾®ç¬‘å›ç­”ï¼šã€Œæˆ‘çœ‹ä½ åƒä¸€å°Šé‡‘ä½›ã€‚ã€è˜‡è»¾è‡ªä»¥ç‚ºå äº†ä¸Šé¢¨ï¼Œæ²¾æ²¾è‡ªå–œã€‚',
            choices: [
                {
                    text: 'é ˜æ‚Ÿç¦ªæ©Ÿï¼šã€Œå¿ƒä¸­æœ‰ä½›ï¼Œæ‰€è¦‹çš†æ˜¯ä½›ã€‚ã€',
                    effect: (p) => {
                        p.creativity += 15;
                        p.attributes.chrys += 10;
                        p.exp += 10;
                        return 'ä½ æ˜ç™½äº†å¢ƒç•Œé«˜ä¸‹åœ¨æ–¼å…§å¿ƒè€Œéå£èˆŒä¹‹çˆ­ï¼Œå¿ƒèƒ¸è±ç„¶é–‹æœ—ã€‚æ–‡æ€+15ã€è‡ªåœ¨+10ã€ç¶“é©—+10ã€‚';
                    }
                },
                {
                    text: 'ç‚ºè˜‡è»¾å–é‡‡ï¼šã€Œç²¾å½©çš„åæ“Šï¼Œè´å¾—æ¼‚äº®ï¼ã€',
                    effect: (p) => {
                        p.attributes.peony += 15;
                        p.attributes.lotus -= 5;
                        return 'ä½ æ¬£è³é€™ä»½æ©Ÿæ™ºèˆ‡ä¸è‚¯åƒè™§çš„éŠ³æ°£ï¼Œèªç‚ºåœ¨äººéš›äº¤å¾€ä¸­ï¼Œæ°£å‹¢å¾ˆé‡è¦ã€‚æ¦®è€€+15ã€è‡ªå®ˆ-5ã€‚';
                    }
                }
            ]
        }

    ];

    // === â¬‡ï¸ æ–°å¢ï¼šå…¸ç±å°æ³¨ï¼ˆUI ç«¯ç”¨ï¼Œä¸æ”¹äº‹ä»¶æ–‡æ¡ˆæœ¬é«”ï¼‰ ===
    function getEventNote(card) {
        const t = (card?.title || '') + (card?.desc || '');
        if (t.includes('å‘¨æ•¦é ¤') || t.includes('æ¿‚æºª') || t.includes('è“®')) {
            return 'å°æ³¨ï¼šã€ˆæ„›è“®èªªã€‰â€”ã€Œä¸­é€šå¤–ç›´ï¼Œä¸è”“ä¸æï¼›é¦™é ç›Šæ¸…ï¼Œå¯é è§€è€Œä¸å¯è¤»ç©ç„‰ã€‚ã€';
        }
        if (t.includes('é™¶æ·µæ˜') || t.includes('æ±ç±¬') || t.includes('èŠ')) {
            return 'å°æ³¨ï¼šé™¶æ½›ã€ˆé£²é…’ã€‰å…¶äº”â€”ã€Œæ¡èŠæ±ç±¬ä¸‹ï¼Œæ‚ ç„¶è¦‹å—å±±ã€‚ã€';
        }
        if (t.includes('ç‰¡ä¸¹') || t.includes('åœ‹è‰²')) {
            return 'å°æ³¨ï¼šæ­·ä¾†ä»¥ç‰¡ä¸¹è±¡å¾µå¯Œè²´æ¦®è€€ï¼Œã€Œå”¯æœ‰ç‰¡ä¸¹çœŸåœ‹è‰²ã€é‚æˆå…¸ã€‚';
        }
        return '';
    }

    // === â¬‡ï¸ åˆä½µï¼šä¿ç•™ä½ åŸæœ¬ eventDeckï¼Œè¿½åŠ  extraEventsï¼ˆé¿å…é‡åï¼‰ ===
    const mergedEventDeck = Array.isArray(eventDeck)
        ? [...eventDeck, ...extraEvents.filter(e => !eventDeck.some(x => x.title === e.title))]
        : extraEvents;
    const _origGetRandomEvent = typeof getRandomEvent === 'function' ? getRandomEvent : null;

    // â–¼â–¼â–¼ è«‹ç”¨é€™æ®µå®Œæ•´çš„ _fallbackGetRandomEvent å‡½æ•¸ï¼Œå–ä»£æ‰èˆŠçš„ â–¼â–¼â–¼
    function _fallbackGetRandomEvent() {
        // âœ… ä¿®æ­£ï¼šå³ä½¿ GameState æœªå®Œå…¨åˆå§‹åŒ–ï¼Œä¹Ÿè¦ç¢ºä¿åŸºæœ¬çµæ§‹å­˜åœ¨
        if (!global.GameState) global.GameState = {};
        if (!global.GameState.gameState) global.GameState.gameState = {};
        if (!global.GameState.gameState.usedEventTitles) {
            global.GameState.gameState.usedEventTitles = [];
        }

        const usedTitles = global.GameState.gameState.usedEventTitles;
        let availableCards = mergedEventDeck.filter(card => !usedTitles.includes(card.title));

        if (availableCards.length === 0) {
            console.log("äº‹ä»¶ç‰Œåº«å·²ç”¨å®Œï¼Œæ­£åœ¨é‡ç½®å’Œæ´—ç‰Œ...");
            global.GameState.gameState.usedEventTitles = [];
            availableCards = mergedEventDeck;

            // Fisherâ€“Yates æ´—ç‰Œ
            for (let i = availableCards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableCards[i], availableCards[j]] = [availableCards[j], availableCards[i]];
            }
            console.log("äº‹ä»¶ç‰Œåº«å·²é‡ç½®!");
        }

        // âœ… ä¿®æ­£ï¼šå¾å‰©é¤˜çš„å¯æŠ½å¡ä¸­æŠ½ä¸€å¼µï¼Œä¸¦ç«‹å³æ¨™è¨˜ç‚ºå·²ä½¿ç”¨
        const selectedCard = availableCards[Math.floor(Math.random() * availableCards.length)];
        if (selectedCard.title) {
            global.GameState.gameState.usedEventTitles.push(selectedCard.title);
        }

        return selectedCard;
    }
    // â–²â–²â–² å–ä»£çµæŸ â–²â–²â–²
    const finalGetRandomEvent = _origGetRandomEvent || _fallbackGetRandomEvent;



    // === â¬‡ï¸ é‡æ–°è¼¸å‡ºï¼Œä¿æŒä½ åŸæœ‰åŒ¯å‡ºéµå ===
    global.GameData = {
        ...(global.GameData || {}),
        boardLayout,
        boardPath,
        TOTAL_CELLS,
        eventDeck: mergedEventDeck,
        getRandomEvent: finalGetRandomEvent,
        getEventNote
    };

})(window);
